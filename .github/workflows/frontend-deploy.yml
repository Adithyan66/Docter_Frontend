name: Frontend CI/CD
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20'  # Your requirement âœ…

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests
      run: npm test || true
    
    - name: Lint
      run: npm run lint || true

  deploy:
    needs: test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Build production
      run: |
        npm ci
        npm run build
      env:
        GENERATE_SOURCEMAP: false
        VITE_APP_API_URL: https://doctor.api.koodecode.online  # Adjust if needed
    
    - name: Deploy to VM
      uses: appleboy/scp-action@v1
      with:
        host: ${{ secrets.VM_IP }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        rm: true
        source: "dist/*"
        target: "/var/www/doctor/frontend/dist/"
        strip_components: 1
    
    - name: Fix permissions & reload nginx
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ secrets.VM_IP }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          sudo chown -R ${{ secrets.VM_USER }}:${{ secrets.VM_USER }} /var/www/doctor/frontend
          sudo chmod -R 755 /var/www/doctor/frontend
          sudo nginx -t && sudo nginx -s reload
          echo "Frontend deployed successfully!"
