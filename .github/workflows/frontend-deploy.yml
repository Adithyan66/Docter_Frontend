# name: Frontend CI/CD
# on:
#   push:
#     branches: [main, develop]
#   pull_request:
#     branches: [main]

# env:
#   NODE_VERSION: '20'

# jobs:
#   test:
#     runs-on: ubuntu-latest
#     steps:
#     - uses: actions/checkout@v4
    
#     - name: Setup Node.js
#       uses: actions/setup-node@v4
#       with:
#         node-version: ${{ env.NODE_VERSION }}
#         cache: 'npm'
    
#     - name: Install dependencies
#       run: npm ci
    
#     - name: Run tests
#       run: npm test || true

#   deploy:
#     needs: test
#     if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
#     runs-on: ubuntu-latest
#     steps:
#     - uses: actions/checkout@v4
    
#     - name: Setup Node.js
#       uses: actions/setup-node@v4
#       with:
#         node-version: ${{ env.NODE_VERSION }}
#         cache: 'npm'
    
#     - name: Install dependencies
#       run: npm ci
    
#     - name: Build production
#       run: npm run build
#       env:
#         VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
#         VITE_ACCESS_TOKEN_KEY: ${{ secrets.VITE_ACCESS_TOKEN_KEY }}
#         VITE_REFRESH_TOKEN_KEY: ${{ secrets.VITE_REFRESH_TOKEN_KEY }}
#         VITE_USER_KEY: ${{ secrets.VITE_USER_KEY }}
#         GENERATE_SOURCEMAP: false
    
#     - name: Deploy to VM via SCP
#       uses: appleboy/scp-action@v0.1.4  # ‚úÖ Stable version
#       with:
#         host: ${{ secrets.VM_IP }}
#         username: ${{ secrets.VM_USER }}
#         key: ${{ secrets.SSH_PRIVATE_KEY }}
#         rm: true
#         source: "dist/*"
#         target: "/var/www/doctor/frontend/dist/"
#         strip_components: 1
    
#     - name: Fix permissions & reload nginx
#       uses: appleboy/ssh-action@v1.0.3  # ‚úÖ This one exists
#       with:
#         host: ${{ secrets.VM_IP }}
#         username: ${{ secrets.VM_USER }}
#         key: ${{ secrets.SSH_PRIVATE_KEY }}
#         script: |
#           sudo chown -R ${{ secrets.VM_USER }}:${{ secrets.VM_USER }} /var/www/doctor/frontend/dist
#           sudo chmod -R 755 /var/www/doctor/frontend/dist
#           sudo nginx -t
#           sudo nginx -s reload
#           echo "‚úÖ Frontend deployed successfully!"
#           ls -la /var/www/doctor/frontend/dist/ | head -3











name: Frontend CI/CD
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests
      run: npm test || true

  deploy:
    needs: test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build production
      run: npm run build
      env:
        VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
        VITE_ACCESS_TOKEN_KEY: ${{ secrets.VITE_ACCESS_TOKEN_KEY }}
        VITE_REFRESH_TOKEN_KEY: ${{ secrets.VITE_REFRESH_TOKEN_KEY }}
        VITE_USER_KEY: ${{ secrets.VITE_USER_KEY }}
        GENERATE_SOURCEMAP: false
    
    - name: üîç Debug Frontend Secrets
      run: |
        echo "VM_IP: '${{ secrets.VM_IP }}'"
        echo "VM_USER: '${{ secrets.VM_USER }}'"
        echo "SSH_PRIVATE_KEY length: $(echo '${{ secrets.SSH_PRIVATE_KEY }}' | wc -c) chars"
    
    - name: Deploy to VM via SCP
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.VM_IP }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        rm: true
        source: "dist/*"
        target: "/var/www/doctor/frontend/dist/"
        strip_components: 1
    
    - name: Fix permissions & reload nginx
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_IP }}
        username: ${{ secrets.VM_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          sudo chown -R adithyanbinu666:adithyanbinu666 /var/www/doctor/frontend/dist
          sudo chmod -R 755 /var/www/doctor/frontend/dist
          sudo nginx -t
          sudo nginx -s reload
          echo "‚úÖ Frontend deployed successfully!"
          ls -la /var/www/doctor/frontend/dist/ | head -3
